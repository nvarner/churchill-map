image: docker:20

variables:
  SAST_EXCLUDED_ANALYZERS: "nodejs-scan, semgrep"

include:
  - template: Security/SAST.gitlab-ci.yml

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm/
    - node_modules/

stages:
  - build_image
  - build
  - check
  - deploy

# build_image stage
build_image:
  stage: build_image
  needs: []
  script:
    - echo $CI_REGISTRY
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker pull $CI_REGISTRY_IMAGE:latest || true
    - docker build --pull --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    paths:
      # Give access to image to later jobs without needing to pull
      - /var/lib/docker/

# build stage
build:
  stage: build
  needs: [build_image]
  variables:
    GIT_STRATEGY: none
  script:
    - id=$(docker run -d --rm churchill-map tail -f /dev/null)
    - docker exec $id npm run build
    - docker cp $id:/usr/src/map/dist dist
    - docker stop $id -t 1
  artifacts:
    paths:
      - dist/

doc:
  stage: build
  needs: [build_image]
  script:
    - id=$(docker run -d --rm churchill-map tail -f /dev/null)
    - docker exec $id npm run doc
    - docker cp $id:/usr/src/map/docs docs
    - docker stop $id -t 1
  artifacts:
    paths:
      - docs/

code_navigation:
  stage: build
  needs: [build_image]
  allow_failure: true
  script:
    - id=$(docker run -d --rm churchill-map tail -f /dev/null)
    - docker exec $id npm run gen-code-nav
    - docker cp $id:/usr/src/map/dump.lsif dump.lsif
    - docker stop $id -t 1
  artifacts:
    reports:
      lsif: dump.lsif

# Check stage
lint:
  stage: check
  needs: [build_image]
  script:
    - docker run churchill-map npm run lint

sast:
  stage: check
  needs: []
  variables:
    SAST_EXCLUDED_PATHS: src/test

test:
  stage: check
  needs: [build_image]
  script:
    - id=$(docker run -d --rm churchill-map tail -f /dev/null)
    - docker exec $id npm run test-ci
    - docker cp $id:/usr/src/map/junit.xml junit.xml
    - docker cp $id:/usr/src/map/coverage/ coverage/
    - docker stop $id -t 1
  artifacts:
    when: always
    paths:
      - junit.xml
      - coverage/cobertura-coverage.xml
    reports:
      junit: junit.xml
      cobertura: coverage/cobertura-coverage.xml

# Deploy stage
deploy-app:
  stage: deploy
  script:
  - apt update -qq && apt install -y -qq lftp
  - lftp -e "set ssl:verify-certificate no; mirror -R dist ." -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST 
  artifacts:
    paths:
      - dist
  only:
    - master

# deploy docs (called pages so docs end up on GitLab Pages)
pages:
  stage: deploy
  script:
    - mv docs/ public/
  artifacts:
    paths:
      - public/
  only:
    - master
